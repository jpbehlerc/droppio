$(document).ready(function(){function e(){this.bloodType=!1,this.radius=!1}var o=["bloodType","nearbyHospitals"],a={4:"O+",1:"A+",2:"B+",3:"AB+",8:"O-",5:"A-",6:"B-",7:"AB-"},t={campaigns:!0,settings:!0},n=new e;$.post("/registerTest",{_xsrf:xsrf_token,type:"creds"}).done(function(e){if(e=JSON.parse(e),respType=e.type,"creds"==respType){dbUser=e.dbUser,dbPass=e.dbPass,dbAdminUser=e.dbAdminUser,dbAdminPass=e.dbAdminPass;var i=new PouchDB("campaigns",{auto_compaction:!1,cache:!1,heartbeat:!0}),r=new PouchDB("https://"+dbAdminUser+":"+dbAdminPass+"@alfredarg.com:6489/campaigns"),s=new PouchDB("settings"+dbUser,{auto_compaction:!1,cache:!1,heartbeat:!0}),c=new PouchDB("https://"+dbUser+":"+dbPass+"@alfredarg.com:6489/settings"+dbUser),l=new PouchDB("stats"+dbUser,{auto_compaction:!1,cache:!1,heartbeat:!0}),d=new PouchDB("https://"+dbAdminUser+":"+dbAdminPass+"@alfredarg.com:6489/stats"+dbUser),m=new PouchDB("algorithms",{auto_compaction:!1,cache:!1,heartbeat:!0}),p=new PouchDB("https://"+dbAdminUser+":"+dbAdminPass+"@alfredarg.com:6489/algorithms");i.allDocs({include_docs:!0}).then(function(e){e.rows.forEach(function(e){doc=e.doc,receiver=doc.name+" "+doc.lastname,hospital=doc.hospital,donors=doc.donors,totalTime=0==doc.status?30:15,created=moment(doc.createdAt),now=moment().tz("America/Argentina/Buenos_Aires"),remaining=now.diff(created,"days")/totalTime,compatible="",doc.compatible.forEach(function(e){compatible+=a[e]+" "}),$("#casperCampaign").find("#campaignReceiver").html(receiver),$("#casperCampaign").find("#campaignHospital").html(hospital),$("#casperCampaign").find("#campaignDonors").find("#neededDonors").html(donors),$("#casperCampaign").find("#campaignCompatibility").html(compatible),newCampaign=$("#casperCampaign").html(),$("#campaigns").append(newCampaign)})}).catch(function(e){$("#test").html(e)}),s.sync(c,{live:!0,retry:!0,back_off_function:function(e){return 0==e?1e3:e>=1e3&&e<18e5?1.5*e:e>=18e5?1.1*e:void 0}}).on("paused",function(e){t.settings&&(t.settings=!1,s.allDocs({include_docs:!0,keys:o}).then(function(e){var o=!0;e.rows.forEach(function(e){"error"in e||null===e.doc?o=!1:n[e.doc._id]=e.doc.value}),o&&i.replicate.from(r,{live:!0,retry:!0,back_off_function:function(e){return 0==e?1e3:e>=1e3&&e<18e5?1.5*e:e>=18e5?1.1*e:void 0},filter:function(e,o){var a=e.compatible.includes(o.query.bloodType),t=o.query.nearbyHospitals.includes(e.hospital),n=e.createdAt>o.query.expiry;return a&&t&&n},query_params:{bloodType:n.bloodType,nearbyHospitals:n.nearbyHospitals,expiry:moment().tz("America/Argentina/Buenos_Aires").subtract(30,"days").valueOf()}}).on("change",function(e){console.log(e),docs=e.docs;for(var o in docs)console.log(docs[o]),doc=docs[o],receiver=doc.name+" "+doc.lastname,hospital=doc.hospital,donors=doc.donors,compatible="",doc.compatible.forEach(function(e){compatible+=a[e]+" "}),$("#casperCampaign").find("#campaignReceiver").html(receiver),$("#casperCampaign").find("#campaignHospital").html(hospital),$("#casperCampaign").find("#campaignDonors").find("#neededDonors").html(donors),$("#casperCampaign").find("#campaignCompatibility").html(compatible),newCampaign=$("#casperCampaign").html(),$("#campaigns").append(newCampaign)})}).catch(function(e){console.log("Aha something nasty happened while syncing campaigns!")}))}).on("error",function(e){console.log("Oops smth happened while trying to sync settings!")}),l.sync(d,{live:!0,retry:!0,back_off_function:function(e){return 0==e?1e3:e>=1e3&&e<18e5?1.5*e:e>=18e5?1.1*e:void 0}}).on("error",function(e){}),m.sync(p,{live:!0,retry:!0,back_off_function:function(e){return 0==e?1e3:e>=1e3&&e<18e5?1.5*e:e>=18e5?1.1*e:void 0}}).on("error",function(e){})}}),$("#home").click(function(e){e.preventDefault(),window.location="https://droppio.org/home"}),$("#campaign").click(function(e){e.preventDefault(),window.location="https://droppio.org/campaign"}),$("#profile").click(function(e){e.preventDefault(),window.location="https://droppio.org/profile"}),$(".datepicker").datepicker({selectMonths:!0,selectYears:!0,min:[1901,1,1],max:!0,Year:2002,selectYears:1e3,labelMonthNext:"Proximo Mes",labelMonthPrev:"Mes Anterior",labelMonthSelect:"Seleccione Mes",labelYearSelect:"Seleccione Año",monthsFull:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],monthsShort:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],weekdaysFull:["Domingo","Lunes","Martes","Miercoles","Jueves","Viernes","Sabado"],weekdaysShort:["Dom","Lun","Mar","Mie","Jue","Vie","Sab"],weekdaysLetter:["D","L","M","M","J","V","S"],today:!1,clear:"Borrar",close:"Cerrar"}),$(".timepicker").timepicker({default:!1,fromnow:0,twelvehour:!0,donetext:"OK",cleartext:"Borrar",canceltext:"Cancelar",autoclose:!0,ampmclickable:!0,aftershow:function(){}}),$("select").formSelect(),$(".spread").click(function(e){swal("Gracias!","Ademas de compartir puedes salvar a esta persona donando!.","success")}),$(".donate").click(function(e){swal({html:'<div class="row center"><div class="col s2 m2 l2"> <i class="fas fa-exclamation-circle ce" style="margin-top:0.5em; margin-left:-0.25em; font-size:2.5em; color:#c91249"></i></div><div class="col s10 m10 l10"><p class="left flow-text" style="text-align:left;color:#c91249">Tenga en cuenta que para donar usted debe:</p></div></div><div class="row" style="margin-top:-1em; text-align:left"><div class="col s2 m2 l2" style="margin-top:-1em"></div><div class="col s10 m10 l10"><ul><li style="margin-bottom:0.5em"> &bull; Pesar más de 50 kilos</li><li style="margin-bottom:0.5em"> &bull; Tener entre 18 y 65 años de edad</li><li style="margin-bottom:0.5em"> &bull; No haber padecido una enfermedad en los ultimos 7 días</li><li style="margin-bottom:0.5em"> &bull; Tener presión arterial normal</li><li style="margin-bottom:0.5em"> &bull; No habese hecho un tatuaje ni haber recibido alguna operacion en el ultimo año</li></ul></div></div></div></div><div class="row center"><div class="col s2 m2 l2"> <i class="fas fa-h-square" style="margin-top:0.5em; margin-left:-0.25em; font-size:2.5em; color:#c91249;"></i></div><div class="col s10 m10 l10"><p class="left flow-text" style="text-align:left; color:#c91249;">Presentarse en Hospital Español<span style="color:black;"> de 8hs a 12hs</span></p></div></div>',showCancelButton:!0,confirmButtonText:"Confirmar",confirmButtonColor:"#ffab40",cancelButtonText:"Cancelar",position:"top-center"}).then(function(e){e.value?(id=$(this).attr("id"),donation={_id:info._id+"@"+id,name:info.name,lastName:info.LastName},settingsDB.get("isAble").then(function(e){campaigns.put(donation).catch(function(e){swal({title:"Oops!",text:"Ocurrió un error al procesar la donación, por favor intente nuevamente :)",type:"error",showConfirmButton:!1})})}).catch(function(e){months={January:"01",February:"02",March:"03",April:"04",May:"05",June:"06",July:"07",August:"08",September:"09",October:"10",November:"11",December:"12"},now=moment().tz("America/Argentina/Buenos_Aires"),birth=info.birthDate.split(" "),day=parseInt(birth[0])<10?"0"+birth[0]:birth[0],month=months[birth[1].split(",")[0]],year=birth[2],age=moment(year+"-"+day+"-"+month+" 00:00").diff(now,"years"),weight=parseInt(info.weight),age>=18&&weight>=50&&(settingsDB.put({_id:"_local/isAble"}),campaigns.put(donation).catch(function(e){swal({title:"Oops!",text:"Ocurrió un error al procesar la donación, por favor intente nuevamente :)",type:"error",showConfirmButton:!1})}))}),swal({title:"Genial!",text:"Estás a un paso de salvar a esta persona, sólo debes ir a donar",type:"success",confirmButtonText:"Ir a donar",showCancelButton:!0,cancelButtonText:"Iré luego"}).then(function(e){console.log("Button value: "+e.value),e.value&&(window.location="https://www.google.com/maps?&z=10&mrt=yp&t=m&q=-32.8996453,-68.878869,13")})):(e.dismiss,swal.DismissReason.cancel)})}),$("#casperImage").html2canvas({onrendered:function(e){var o=e.toDataURL("image/png");window.open(o)}}),$(".spread").click(function(){})});